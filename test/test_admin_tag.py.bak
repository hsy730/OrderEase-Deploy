import os
import pytest
import requests

from conftest import API_BASE_URL


class TestAdminTagAPI:
    """管理员标签管理接口测试"""

    def test_create_tag(self):
        """测试创建标签"""
        url = f"{API_BASE_URL}/admin/tag/create"
        payload = {
            "name": f"Test Tag {os.urandom(4).hex()}",
            "description": "Test tag description"
        }
        headers = {"Authorization": "Bearer test_token"}
        response = requests.post(url, json=payload, headers=headers)
        assert response.status_code in [200, 400, 401]

    def test_get_tag_list(self):
        """测试获取标签列表"""
        url = f"{API_BASE_URL}/admin/tag/list"
        params = {
            "page": 1,
            "pageSize": 10
        }
        headers = {"Authorization": "Bearer test_token"}
        response = requests.get(url, params=params, headers=headers)
        assert response.status_code in [200, 400, 401]

    def test_get_tag_detail(self):
        """测试获取标签详情"""
        url = f"{API_BASE_URL}/admin/tag/detail"
        params = {"tagId": "1"}
        headers = {"Authorization": "Bearer test_token"}
        response = requests.get(url, params=params, headers=headers)
        assert response.status_code in [200, 400, 401, 404]

    def test_update_tag(self):
        """测试更新标签信息"""
        url = f"{API_BASE_URL}/admin/tag/update"
        payload = {
            "tag_id": "1",
            "name": "Updated Tag Name",
            "description": "Updated description"
        }
        headers = {"Authorization": "Bearer test_token"}
        response = requests.put(url, json=payload, headers=headers)
        assert response.status_code in [200, 400, 401, 404]

    def test_delete_tag(self):
        """测试删除标签"""
        url = f"{API_BASE_URL}/admin/tag/delete"
        params = {"tagId": "999"}
        headers = {"Authorization": "Bearer test_token"}
        response = requests.delete(url, params=params, headers=headers)
        assert response.status_code in [200, 400, 401, 404]

    def test_batch_tag_products(self):
        """测试批量打标签"""
        url = f"{API_BASE_URL}/admin/tag/batch-tag"
        payload = {
            "tag_id": "1",
            "product_ids": ["1", "2"]
        }
        headers = {"Authorization": "Bearer test_token"}
        response = requests.post(url, json=payload, headers=headers)
        assert response.status_code in [200, 400, 401]

    def test_get_tag_online_products(self):
        """测试获取标签关联的已上架商品"""
        url = f"{API_BASE_URL}/admin/tag/online-products"
        params = {"tagId": "1"}
        headers = {"Authorization": "Bearer test_token"}
        response = requests.get(url, params=params, headers=headers)
        assert response.status_code in [200, 400, 401, 404]

    def test_get_bound_tags(self):
        """测试获取商品已绑定的标签"""
        url = f"{API_BASE_URL}/admin/tag/bound-tags"
        params = {"productId": "1"}
        headers = {"Authorization": "Bearer test_token"}
        response = requests.get(url, params=params, headers=headers)
        assert response.status_code in [200, 400, 401, 404]

    def test_get_unbound_tags(self):
        """测试获取商品未绑定的标签"""
        url = f"{API_BASE_URL}/admin/tag/unbound-tags"
        params = {"productId": "1"}
        headers = {"Authorization": "Bearer test_token"}
        response = requests.get(url, params=params, headers=headers)
        assert response.status_code in [200, 400, 401, 404]

    def test_batch_tag_product(self):
        """测试批量设置商品标签"""
        url = f"{API_BASE_URL}/admin/tag/batch-tag-product"
        payload = {
            "product_id": "1",
            "tag_ids": ["1", "2"]
        }
        headers = {"Authorization": "Bearer test_token"}
        response = requests.post(url, json=payload, headers=headers)
        assert response.status_code in [200, 400, 401]

    def test_batch_untag_products(self):
        """测试批量解绑商品标签"""
        url = f"{API_BASE_URL}/admin/tag/batch-untag"
        payload = {
            "tag_id": "1",
            "product_ids": ["1", "2"]
        }
        headers = {"Authorization": "Bearer test_token"}
        response = requests.delete(url, json=payload, headers=headers)
        assert response.status_code in [200, 400, 401]

    def test_get_unbound_tags_list(self):
        """测试获取没有绑定商品的标签列表"""
        url = f"{API_BASE_URL}/admin/tag/unbound-list"
        headers = {"Authorization": "Bearer test_token"}
        response = requests.get(url, headers=headers)
        assert response.status_code in [200, 400, 401]

    def test_get_unbound_products_for_tag(self):
        """测试获取标签未绑定的商品列表"""
        url = f"{API_BASE_URL}/admin/tag/unbound-products"
        params = {"tagId": "1"}
        headers = {"Authorization": "Bearer test_token"}
        response = requests.get(url, params=params, headers=headers)
        assert response.status_code in [200, 400, 401, 404]

    def test_get_tag_bound_products(self):
        """测试获取标签已绑定的商品列表"""
        url = f"{API_BASE_URL}/admin/tag/bound-products"
        params = {"tagId": "1"}
        headers = {"Authorization": "Bearer test_token"}
        response = requests.get(url, params=params, headers=headers)
        assert response.status_code in [200, 400, 401, 404]
